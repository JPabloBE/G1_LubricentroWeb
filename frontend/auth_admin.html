<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lubricentro - Login Staff</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background:#0f0f0f;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:20px;
      color:#eaeaea;
    }
    .container{
      background:#fff;
      border-radius:15px;
      box-shadow:0 10px 30px rgba(0,0,0,.45);
      overflow:hidden;
      max-width:420px;
      width:100%;
      color:#111;
      border:1px solid #1f1f1f;
      padding:28px;
    }
    h2{ text-align:center; margin-bottom:18px; }
    .sub{ text-align:center; color:#444; margin-bottom:20px; }
    .form-group{ margin-bottom:16px; }
    label{ display:block; margin-bottom:6px; font-weight:600; color:#222; }
    input{
      width:100%;
      padding:12px;
      border:1px solid #cfcfcf;
      border-radius:8px;
      font-size:14px;
      background:#fff;
      color:#111;
    }
    input:focus{
      outline:none;
      border-color:#111;
      box-shadow:0 0 0 3px rgba(0,0,0,.08);
    }
    button{
      width:100%;
      padding:12px;
      background:#111;
      color:#fff;
      border:1px solid #111;
      border-radius:8px;
      font-size:16px;
      font-weight:700;
      cursor:pointer;
    }
    button:hover{ background:#000; }
    .message{
      padding:12px;
      border-radius:8px;
      margin-bottom:14px;
      display:none;
      font-weight:600;
    }
    .message.error{ background:#fee; color:#c33; border:1px solid #fcc; }
    .message.success{ background:#efe; color:#2f7a2f; border:1px solid #cfc; }
    .hint{
      margin-top:14px;
      font-size:13px;
      color:#666;
      text-align:center;
    }
    .links{
      margin-top:12px;
      text-align:center;
      font-size:13px;
    }
    .links a{
      color:#111;
      text-decoration:none;
      font-weight:700;
    }
    .links a:hover{ text-decoration:underline; }
  </style>
</head>

<body>
  <div class="container">
    <h2>Lubricentro</h2>
    <div class="sub">Acceso exclusivo para <b>Staff / Admin</b></div>

    <div id="message" class="message"></div>

    <form id="login-form">
      <div class="form-group">
        <label for="login-username">Usuario</label>
        <input type="text" id="login-username" required />
      </div>
      <div class="form-group">
        <label for="login-password">Contraseña</label>
        <input type="password" id="login-password" required />
      </div>
      <button type="submit">Iniciar Sesión</button>
    </form>

    <div class="hint">
      Si necesitás un usuario, pedile a un admin/staff que lo cree desde el dashboard.
    </div>

    <!-- opcional -->
    <div class="links">
      ¿Sos cliente? <a href="./auth_client.html">Ir al login de cliente</a>
    </div>
  </div>

  <script>
    const API_URL = "http://localhost:8000/api/auth";
    let accessToken = localStorage.getItem("access_token");

    function showMessage(text, type) {
      const el = document.getElementById("message");
      el.textContent = text;
      el.className = `message ${type}`;
      el.style.display = "block";
    }

    function hideMessage() {
      document.getElementById("message").style.display = "none";
    }

    function isAdminUser(me) {
      return me.user_type === "admin" || me.is_staff === true || me.is_superuser === true;
    }

    async function tryAutoRedirect() {
      if (!accessToken) return;

      try {
        const meRes = await fetch(`${API_URL}/me/`, {
          headers: { "Authorization": `Bearer ${accessToken}` }
        });

        if (!meRes.ok) {
          localStorage.removeItem("access_token");
          localStorage.removeItem("refresh_token");
          return;
        }

        const me = await meRes.json().catch(() => null);
        if (!me || !isAdminUser(me)) {
          localStorage.removeItem("access_token");
          localStorage.removeItem("refresh_token");
          showMessage("Tu usuario no tiene permisos de Staff/Admin.", "error");
          return;
        }

        // IMPORTANTE: ahora el dashboard está dentro de /admin/
        window.location.href = "./admin/dashboard.html";
      } catch (_) {
        // nada
      }
    }

    tryAutoRedirect();

    document.getElementById("login-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      hideMessage();

      const username = document.getElementById("login-username").value.trim();
      const password = document.getElementById("login-password").value;

      try {
        const res = await fetch(`${API_URL}/login/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          showMessage(data.detail || "Error: Solo staff/admin pueden iniciar sesión.", "error");
          return;
        }

        if (!data.access) {
          showMessage("No se recibió access_token.", "error");
          return;
        }

        localStorage.setItem("access_token", data.access);
        if (data.refresh) localStorage.setItem("refresh_token", data.refresh);
        accessToken = data.access;

        // Verificación extra: asegurar que este usuario sea admin/staff
        const meRes = await fetch(`${API_URL}/me/`, {
          headers: { "Authorization": `Bearer ${accessToken}` }
        });

        if (!meRes.ok) {
          showMessage("No se pudo validar la sesión.", "error");
          localStorage.removeItem("access_token");
          localStorage.removeItem("refresh_token");
          return;
        }

        const me = await meRes.json().catch(() => null);
        if (!me || !isAdminUser(me)) {
          showMessage("Este usuario no tiene permisos de Staff/Admin.", "error");
          localStorage.removeItem("access_token");
          localStorage.removeItem("refresh_token");
          return;
        }

        window.location.href = "./admin/dashboard.html";
      } catch (err) {
        console.error(err);
        showMessage("Error de conexión con el servidor.", "error");
      }
    });
  </script>
</body>
</html>
