<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mis Órdenes de Trabajo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <span class="navbar-brand">Lubricentro | Cliente</span>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-light btn-sm" href="./dashboard.html">Dashboard</a>
      <button id="btnLogout" class="btn btn-warning btn-sm">Salir</button>
    </div>
  </div>
</nav>

<div class="container py-4">
  <div id="msg" class="alert d-none"></div>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="m-0">Mis Órdenes de Trabajo</h3>
    <button id="btnReload" class="btn btn-sm btn-dark">Recargar</button>
  </div>

  <div id="list" class="d-grid gap-3"></div>
</div>

<script>
  const API_BASE = "http://127.0.0.1:8000";
  const token = localStorage.getItem("customer_access_token");
  const URL = `${API_BASE}/api/customer-work-orders/`;

  function showMsg(text, type="danger"){
    const el = document.getElementById("msg");
    el.className = `alert alert-${type}`;
    el.textContent = text;
    el.classList.remove("d-none");
  }

  async function fetchJSON(url, options={}){
    const res = await fetch(url, options);
    let data = null;
    try{ data = await res.json(); }catch(_){}
    if(!res.ok){
      const detail = data?.detail || res.statusText || `HTTP ${res.status}`;
      const err = new Error(detail);
      err.status = res.status;
      err.body = data;
      throw err;
    }
    return data;
  }

  function normalizeList(data) {
    if (Array.isArray(data)) return data;
    if (data && Array.isArray(data.results)) return data.results;
    return [];
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function fmt(dt){
    if(!dt) return "—";
    try{ return new Date(dt).toLocaleString("es-CR"); }catch(_){ return dt; }
  }

  function money(v){
    if(v === null || v === undefined || v === "") return "—";
    const n = Number(v);
    if(Number.isNaN(n)) return String(v);
    return n.toLocaleString("es-CR", { style:"currency", currency:"CRC" });
  }

  function badgeClass(status){
    const s = String(status || "").toLowerCase();
    if(["ready","closed","done","completed"].includes(s)) return "text-bg-success";
    if(["cancelled","canceled"].includes(s)) return "text-bg-danger";
    if(["open","diagnosing","in_progress","waiting_parts","awaiting_authorization","authorized"].includes(s)) return "text-bg-primary";
    return "text-bg-secondary";
  }

  function renderLines(title, lines, kind){
    if(!lines || !lines.length){
      return `
        <div class="mb-3">
          <div class="fw-semibold mb-1">${escapeHtml(title)}</div>
          <div class="text-muted small">No hay ${kind} registrados.</div>
        </div>
      `;
    }

    return `
      <div class="mb-3">
        <div class="fw-semibold mb-2">${escapeHtml(title)}</div>
        <div class="list-group">
          ${lines.map(ln => {
            const name = kind === "servicios"
              ? (ln.service_name || "Servicio")
              : (ln.product_name || "Producto");

            const sub = kind === "productos" && ln.product_sku ? `SKU: ${escapeHtml(ln.product_sku)}` : "";
            const desc = ln.description ? escapeHtml(ln.description) : "";
            const qty = ln.qty ?? "—";
            const unit = money(ln.unit_price);
            const total = money(ln.line_total);

            return `
              <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-start gap-3">
                  <div>
                    <div class="fw-semibold">${escapeHtml(name)}</div>
                    ${sub ? `<div class="text-muted small">${sub}</div>` : ""}
                    ${desc ? `<div class="text-muted small">${desc}</div>` : ""}
                    ${ln.status ? `<div class="mt-1"><span class="badge ${badgeClass(ln.status)}">${escapeHtml(ln.status)}</span></div>` : ""}
                  </div>
                  <div class="text-end small">
                    <div><span class="text-muted">Cant:</span> ${escapeHtml(qty)}</div>
                    <div><span class="text-muted">Unit:</span> ${escapeHtml(unit)}</div>
                    <div class="fw-semibold"><span class="text-muted">Total:</span> ${escapeHtml(total)}</div>
                  </div>
                </div>
              </div>
            `;
          }).join("")}
        </div>
      </div>
    `;
  }

  function renderCard(wo, idx){
    const title = `Orden de trabajo #${idx + 1}`;

    const vehicle = [
      wo.vehicle_plate ? `Placa ${wo.vehicle_plate}` : "",
      [wo.vehicle_make, wo.vehicle_model, wo.vehicle_year].filter(Boolean).join(" ")
    ].filter(Boolean).join(" · ") || "Vehículo —";

    const status = wo.status || "—";
    const auth = wo.authorization_status || "—";

    const services = wo.services || [];
    const products = wo.products || [];

    const servicesTotal = money(wo.services_total);
    const productsTotal = money(wo.products_total);
    const computedTotal = money(wo.computed_total);
    const estimated = money(wo.estimated_total);

    const collapseId = `woDetails_${idx}`;

    return `
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start gap-3">
            <div>
              <div class="h5 mb-1">${escapeHtml(title)}</div>
              <div class="text-muted">${escapeHtml(vehicle)}</div>
              <div class="text-muted small">Abierta: ${escapeHtml(fmt(wo.opened_at))}${wo.closed_at ? ` · Cerrada: ${escapeHtml(fmt(wo.closed_at))}` : ""}</div>
            </div>
            <div class="text-end">
              <div class="mb-1"><span class="badge ${badgeClass(status)}">${escapeHtml(status)}</span></div>
              <div><span class="badge text-bg-info">${escapeHtml(auth)}</span></div>
            </div>
          </div>

          ${(wo.customer_symptoms || wo.diagnosis || wo.notes) ? `
            <hr>
            ${wo.customer_symptoms ? `<div class="mb-2"><div class="fw-semibold">Síntomas</div><div class="text-muted small">${escapeHtml(wo.customer_symptoms)}</div></div>` : ""}
            ${wo.diagnosis ? `<div class="mb-2"><div class="fw-semibold">Diagnóstico</div><div class="text-muted small">${escapeHtml(wo.diagnosis)}</div></div>` : ""}
            ${wo.notes ? `<div class="mb-2"><div class="fw-semibold">Notas</div><div class="text-muted small">${escapeHtml(wo.notes)}</div></div>` : ""}
          ` : ""}

          <hr>

          <div class="d-flex flex-wrap gap-2 align-items-center">
            <button class="btn btn-dark btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false">
              Ver detalles (servicios y productos)
            </button>

            <span class="badge text-bg-secondary">Servicios: ${services.length}</span>
            <span class="badge text-bg-secondary">Productos: ${products.length}</span>

            <span class="ms-auto small text-muted">
              Total calc.: <span class="fw-semibold">${escapeHtml(computedTotal)}</span>
              ${wo.estimated_total != null ? ` · Estimado: <span class="fw-semibold">${escapeHtml(estimated)}</span>` : ""}
            </span>
          </div>

          <div class="collapse mt-3" id="${collapseId}">
            ${renderLines("Servicios", services, "servicios")}
            ${renderLines("Productos", products, "productos")}

            <div class="border-top pt-2 small">
              <div class="d-flex justify-content-between">
                <span class="text-muted">Subtotal servicios</span>
                <span class="fw-semibold">${escapeHtml(servicesTotal)}</span>
              </div>
              <div class="d-flex justify-content-between">
                <span class="text-muted">Subtotal productos</span>
                <span class="fw-semibold">${escapeHtml(productsTotal)}</span>
              </div>
              <div class="d-flex justify-content-between">
                <span class="text-muted">Total calculado</span>
                <span class="fw-semibold">${escapeHtml(computedTotal)}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  async function load(){
    if(!token){
      showMsg("No hay sesión de cliente. Iniciá sesión.", "warning");
      return;
    }

    const data = await fetchJSON(URL, {
      headers: { "Authorization": `Bearer ${token}` }
    });

    const rows = normalizeList(data);
    const list = document.getElementById("list");
    list.innerHTML = "";

    if(!rows.length){
      list.innerHTML = `
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="text-muted">No tenés órdenes de trabajo registradas.</div>
          </div>
        </div>
      `;
      return;
    }

    rows.forEach((wo, idx) => {
      const wrapper = document.createElement("div");
      wrapper.innerHTML = renderCard(wo, idx);
      list.appendChild(wrapper.firstElementChild);
    });
  }

  document.getElementById("btnReload").onclick = () => load();

  document.getElementById("btnLogout").onclick = () => {
    localStorage.removeItem("customer_access_token");
    window.location.href = "../auth_client.html";
  };

  load();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
