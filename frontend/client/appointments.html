<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cliente | Citas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <span class="navbar-brand">Lubricentro | Cliente</span>
    <div class="d-flex gap-2 align-items-center">
      <a class="btn btn-outline-light btn-sm" href="./dashboard.html">Dashboard</a>
      <button id="btnLogout" class="btn btn-warning btn-sm">Logout</button>
    </div>
  </div>
</nav>

<div class="container py-4">
  <div id="msg" class="alert d-none" role="alert"></div>

  <div class="row g-3">
    <div class="col-12 col-lg-5">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="mb-3">Crear cita</h5>

          <div class="mb-2">
            <label class="form-label">Vehículo</label>
            <select id="vehicleSelect" class="form-select" required></select>
          </div>

          <div class="mb-2">
            <label class="form-label">Servicio</label>
            <select id="serviceSelect" class="form-select" required></select>
          </div>

          <div class="mb-2">
            <label class="form-label">Horario disponible</label>
            <select id="slotSelect" class="form-select" required></select>
            <div class="text-muted small mt-1">Solo aparecen horarios con cupo disponible.</div>
          </div>

          <div class="mb-2">
            <label class="form-label">Trabajo solicitado (opcional)</label>
            <textarea id="requestedWork" class="form-control" rows="3"></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label">Notas (opcional)</label>
            <textarea id="notes" class="form-control" rows="2"></textarea>
          </div>

          <button id="btnCreate" class="btn btn-primary w-100">Crear cita</button>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-7">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
        <h5 class="m-0">Mis citas</h5>
        <div class="d-flex gap-2 align-items-center">
          <select id="filterView" class="form-select form-select-sm" style="width: 180px;">
            <option value="active">Activas</option>
            <option value="all">Todas</option>
          </select>
          <button id="btnReload" class="btn btn-sm btn-dark">Recargar</button>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-striped m-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th>Placa</th>
                  <th>Servicio</th>
                  <th>Horario</th>
                  <th>Estado</th>
                  <th>Progreso</th>
                  <th>Mensaje</th>
                  <th style="width: 160px;">Acción</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  const API_BASE = "http://127.0.0.1:8000";
  const token = localStorage.getItem("customer_access_token");
  const CLOSED_STATUSES = new Set(["completed", "cancelled", "no_show", "rejected"]);

  function showMsg(text, type="danger"){
    const el = document.getElementById("msg");
    el.className = `alert alert-${type}`;
    el.textContent = text;
    el.classList.remove("d-none");
  }

  async function fetchJSON(url, options = {}) {
    const res = await fetch(url, options);
    let data = null;
    try { data = await res.json(); } catch (_) {}
    if (!res.ok) throw new Error(data?.detail || JSON.stringify(data) || res.statusText);
    return data;
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function fmt(dt){
    if (!dt) return "";
    return new Date(dt).toLocaleString();
  }

  function slotLabel(a){
    const s = a.slot_start || a.scheduled_start;
    const e = a.slot_end || a.scheduled_end;
    return `${fmt(s)}${e ? " → " + fmt(e) : ""}`;
  }

  function canCancel(status){
    return String(status || "").toLowerCase() === "scheduled";
  }

  async function loadVehicles(){
    const data = await fetchJSON(`${API_BASE}/api/customer-vehicles/`, {
      headers: { "Authorization": `Bearer ${token}` }
    });

    const rows = Array.isArray(data) ? data : (data.results || []);
    const sel = document.getElementById("vehicleSelect");
    sel.innerHTML = "";

    if (rows.length === 0){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "No tenés vehículos registrados";
      sel.appendChild(opt);
      sel.disabled = true;
      return;
    }

    sel.disabled = false;
    for (const v of rows){
      const opt = document.createElement("option");
      opt.value = v.vehicle_id;
      const label = `${v.plate}${v.make ? " - " + v.make : ""}${v.model ? " " + v.model : ""}${v.year ? " (" + v.year + ")" : ""}`;
      opt.textContent = label;
      sel.appendChild(opt);
    }
  }

  async function loadServices(){
    const data = await fetchJSON(`${API_BASE}/api/services/customer/`, {
      headers: { "Authorization": `Bearer ${token}` }
    });

    const rows = Array.isArray(data) ? data : (data.results || []);
    const sel = document.getElementById("serviceSelect");
    sel.innerHTML = "";

    if (rows.length === 0){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "No hay servicios disponibles";
      sel.appendChild(opt);
      sel.disabled = true;
      return;
    }

    sel.disabled = false;
    for (const s of rows){
      const opt = document.createElement("option");
      opt.value = s.service_id;
      const price = (s.base_price != null) ? ` - ₡${Number(s.base_price).toLocaleString()}` : "";
      opt.textContent = `${s.name}${price}`;
      sel.appendChild(opt);
    }
  }

  async function loadSlots(){
    const data = await fetchJSON(`${API_BASE}/api/customer-slots/`, {
      headers: { "Authorization": `Bearer ${token}` }
    });

    const rows = Array.isArray(data) ? data : (data.results || []);
    const sel = document.getElementById("slotSelect");
    sel.innerHTML = "";

    if (rows.length === 0){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "No hay horarios disponibles";
      sel.appendChild(opt);
      sel.disabled = true;
      return;
    }

    sel.disabled = false;
    for (const s of rows){
      const opt = document.createElement("option");
      opt.value = s.slot_id;
      const label = `${fmt(s.start_at)}${s.end_at ? " → " + fmt(s.end_at) : ""} (Cupo: ${s.remaining_capacity})`;
      opt.textContent = label;
      sel.appendChild(opt);
    }
  }

  function filterAppointments(rows){
    const mode = document.getElementById("filterView").value;
    if (mode === "all") return rows;
    return rows.filter(a => !CLOSED_STATUSES.has(String(a.status || "").toLowerCase()));
  }

  function progressBar(p){
    const val = Math.max(0, Math.min(100, Number(p ?? 0)));
    return `
      <div class="progress" style="height: 12px;">
        <div class="progress-bar" role="progressbar" style="width:${val}%;" aria-valuenow="${val}" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
      <div class="small text-muted mt-1">${val}%</div>
    `;
  }

  async function loadAppointments(){
    const data = await fetchJSON(`${API_BASE}/api/customer-appointments/`, {
      headers: { "Authorization": `Bearer ${token}` }
    });

    let rows = Array.isArray(data) ? data : (data.results || []);
    rows = filterAppointments(rows);

    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    for (const a of rows){
      const msg = (a.admin_message || "").trim();
      const cancellable = canCancel(a.status);

      const actionCell = cancellable
        ? `<button class="btn btn-sm btn-outline-danger" data-action="cancel" data-id="${a.appointment_id}">Cancelar</button>`
        : `<span class="text-muted small">No cancelable</span>`;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="fw-semibold">${escapeHtml(a.vehicle_plate || "")}</td>
        <td>${escapeHtml(a.service_name || "")}</td>
        <td class="small">${escapeHtml(slotLabel(a))}</td>
        <td><span class="badge text-bg-secondary">${escapeHtml(a.status || "")}</span></td>
        <td>${progressBar(a.progress_percent)}</td>
        <td class="small">${msg ? escapeHtml(msg) : "<span class='text-muted'>—</span>"}</td>
        <td>${actionCell}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  document.getElementById("btnCreate").addEventListener("click", async () => {
    try{
      const vehicle_id = document.getElementById("vehicleSelect").value;
      const service_id = document.getElementById("serviceSelect").value;
      const slot_id = document.getElementById("slotSelect").value;
      const requested_work = (document.getElementById("requestedWork").value || "").trim();
      const notes = (document.getElementById("notes").value || "").trim();

      if (!vehicle_id) { showMsg("Seleccioná un vehículo.", "warning"); return; }
      if (!service_id) { showMsg("Seleccioná un servicio.", "warning"); return; }
      if (!slot_id) { showMsg("Seleccioná un horario.", "warning"); return; }

      const payload = {
        vehicle_id,
        service_id,
        slot_id,
        requested_work: requested_work || null,
        notes: notes || null
      };

      await fetchJSON(`${API_BASE}/api/customer-appointments/`, {
        method: "POST",
        headers: { "Content-Type":"application/json", "Authorization": `Bearer ${token}` },
        body: JSON.stringify(payload)
      });

      showMsg("Cita creada correctamente.", "success");
      document.getElementById("requestedWork").value = "";
      document.getElementById("notes").value = "";
      await loadSlots();
      await loadAppointments();
    }catch(err){
      showMsg(err.message || "Error", "danger");
    }
  });

  document.getElementById("tbody").addEventListener("click", async (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;

    const id = btn.dataset.id;
    const action = btn.dataset.action;

    try{
      if (action === "cancel"){
        await fetchJSON(`${API_BASE}/api/customer-appointments/${id}/`, {
          method: "DELETE",
          headers: { "Authorization": `Bearer ${token}` }
        });
        showMsg("Cita cancelada.", "success");
        await loadSlots();
        await loadAppointments();
      }
    }catch(err){
      showMsg(err.message || "Error", "danger");
    }
  });

  document.getElementById("btnReload").addEventListener("click", () => loadAppointments());
  document.getElementById("filterView").addEventListener("change", () => loadAppointments());

  document.getElementById("btnLogout").addEventListener("click", () => {
    localStorage.removeItem("customer_access_token");
    window.location.href = "../auth_client.html";
  });

  (async () => {
    if (!token){
      window.location.href = "../auth_client.html";
      return;
    }

    try{
      await loadVehicles();
      await loadServices();
      await loadSlots();
      await loadAppointments();
    }catch(err){
      showMsg("Sesión inválida o expirada. Iniciá sesión nuevamente.", "warning");
      setTimeout(() => (window.location.href = "../auth_client.html"), 900);
    }
  })();
</script>
</body>
</html>
