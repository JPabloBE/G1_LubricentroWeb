<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Lubricentro | Autos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <span class="navbar-brand">Lubricentro | Autos</span>
    <div class="d-flex gap-2 align-items-center">
      <span id="whoami" class="text-white-50 small"></span>
      <button id="btnLogout" class="btn btn-warning btn-sm">Logout</button>
    </div>
  </div>
</nav>

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <aside class="col-12 col-md-3 col-lg-2 bg-white border-end" style="min-height: calc(100vh - 56px);">
      <div class="p-3">
        <div class="fw-semibold">Menú</div>
        <hr>
        <div class="list-group">
          <a class="list-group-item list-group-item-action" href="./dashboard.html">Dashboard</a>
          <a class="list-group-item list-group-item-action" href="./dashboard_categories.html">Catálogo → Categorías</a>
          <a class="list-group-item list-group-item-action" href="./dashboard_products.html">Catálogo → Productos</a>
          <a class="list-group-item list-group-item-action" href="./dashboard_customers.html">Clientes</a>
          <a class="list-group-item list-group-item-action" href="./dashboard_services.html">Servicios</a>
          <a class="list-group-item list-group-item-action" href="./dashboard_staff_users.html">Usuarios (Staff/Admin)</a>
          <a class="list-group-item list-group-item-action active" href="./dashboard_vehicles.html">Autos</a>
          <a class="list-group-item list-group-item-action" href="./dashboard_appointments.html">Citas</a>
          <a class="list-group-item list-group-item-action" href="./dashboard_appointment_slots.html">Horarios de Citas</a>
          <a class="list-group-item list-group-item-action" href="./dashboard_work_orders.html">Órdenes de Trabajo</a>

        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="col-12 col-md-9 col-lg-10 p-4">

      <div id="msg" class="alert d-none" role="alert"></div>

      <div class="d-flex gap-2 align-items-center mb-3">
        <h4 class="m-0">Autos</h4>
        <button id="btnNew" class="btn btn-dark btn-sm ms-auto">Nuevo auto</button>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <div class="row g-2 mb-3">
            <div class="col-12 col-md-4">
              <label class="form-label">Filtrar por cliente</label>
              <select id="filterCustomer" class="form-select">
                <option value="">(Todos)</option>
              </select>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Buscar por placa</label>
              <input id="filterPlate" class="form-control" placeholder="Ej: ABC123">
            </div>
            <div class="col-12 col-md-4 d-flex align-items-end">
              <button id="btnApplyFilters" class="btn btn-outline-dark w-100">Aplicar</button>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th>Placa</th>
                  <th>Marca</th>
                  <th>Modelo</th>
                  <th>Año</th>
                  <th>Cliente</th>
                  <th>Foto</th>
                  <th style="width:180px;">Acciones</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

    </main>
  </div>
</div>

<!-- Modal Create/Edit -->
<div class="modal fade" id="modal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="modalTitle" class="modal-title">Auto</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="id">

        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Cliente</label>
            <select id="customer_id" class="form-select" required></select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Placa</label>
            <input id="plate" class="form-control" required placeholder="Ej: ABC123">
          </div>

          <div class="col-md-4">
            <label class="form-label">Marca</label>
            <input id="make" class="form-control" placeholder="Toyota">
          </div>

          <div class="col-md-4">
            <label class="form-label">Modelo</label>
            <input id="model" class="form-control" placeholder="Corolla">
          </div>

          <div class="col-md-4">
            <label class="form-label">Año</label>
            <input id="year" type="number" class="form-control" placeholder="2020">
          </div>

          <div class="col-md-6">
            <label class="form-label">VIN</label>
            <input id="vin" class="form-control" placeholder="(Opcional)">
          </div>

          <div class="col-md-6">
            <label class="form-label">Color</label>
            <input id="color" class="form-control" placeholder="Rojo">
          </div>

          <div class="col-12">
            <label class="form-label">Imagen (URL)</label>
            <input id="image_url" class="form-control" placeholder="https://...">
            <div class="form-text">Opcional. Se mostrará como miniatura en la tabla.</div>
          </div>

          <div class="col-12">
            <label class="form-label">Notas</label>
            <textarea id="notes" class="form-control" rows="3"></textarea>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button id="btnSave" class="btn btn-dark">Guardar</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_BASE = "http://localhost:8000";
  const API_VEHICLES = `${API_BASE}/api/vehicles/`;
  const API_CUSTOMERS = `${API_BASE}/api/customers/`;
  const token = localStorage.getItem("access_token");

  const modal = new bootstrap.Modal(document.getElementById("modal"));

  function headersAuth() {
    return { "Content-Type": "application/json", "Authorization": `Bearer ${token}` };
  }

  function showMsg(text, type="danger") {
    const el = document.getElementById("msg");
    el.className = `alert alert-${type}`;
    el.textContent = text;
    el.classList.remove("d-none");
  }

  function clearMsg() {
    const el = document.getElementById("msg");
    el.classList.add("d-none");
  }

  async function fetchJSON(url, options = {}) {
    const res = await fetch(url, options);
    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch (_) {}

    if (!res.ok) {
      throw new Error(data ? JSON.stringify(data) : (text || res.statusText));
    }
    return data;
  }

  function normalizeList(apiResponse) {
    if (Array.isArray(apiResponse)) return apiResponse;
    if (apiResponse && Array.isArray(apiResponse.results)) return apiResponse.results;
    return [];
  }

  async function ensureAdmin() {
    if (!token) return false;
    const me = await fetchJSON(`${API_BASE}/api/auth/me/`, {
      headers: { "Authorization": `Bearer ${token}` }
    });
    document.getElementById("whoami").textContent = me?.full_name || me?.username || me?.email || "Admin";
    return me.user_type === "admin" || me.is_staff === true || me.is_superuser === true;
  }

  document.getElementById("btnLogout").addEventListener("click", async () => {
    try {
      await fetch(`${API_BASE}/api/auth/logout/`, { method: "POST", headers: { "Authorization": `Bearer ${token}` } });
    } catch (_) {}
    localStorage.removeItem("access_token");
    localStorage.removeItem("refresh_token");
    window.location.href = "./auth.html";
  });

  // --- State ---
  let customers = [];
  let vehicles = [];

  function customerLabel(c) {
    const name = c?.full_name || "(Sin nombre)";
    const phone = c?.phone ? ` • ${c.phone}` : "";
    return `${name}${phone}`;
  }

  // --- Loaders ---
  async function loadCustomers() {
    const raw = await fetchJSON(API_CUSTOMERS, { headers: headersAuth() });
    customers = normalizeList(raw);

    // Modal select
    const sel = document.getElementById("customer_id");
    sel.innerHTML = "";
    for (const c of customers) {
      const opt = document.createElement("option");
      opt.value = c.customer_id;
      opt.textContent = customerLabel(c);
      sel.appendChild(opt);
    }

    // Filter select
    const f = document.getElementById("filterCustomer");
    f.innerHTML = `<option value="">(Todos)</option>`;
    for (const c of customers) {
      const opt = document.createElement("option");
      opt.value = c.customer_id;
      opt.textContent = customerLabel(c);
      f.appendChild(opt);
    }
  }

  async function loadVehicles() {
    clearMsg();
    const customer_id = document.getElementById("filterCustomer").value;
    const plate = document.getElementById("filterPlate").value.trim();

    const params = new URLSearchParams();
    if (customer_id) params.set("customer_id", customer_id);
    if (plate) params.set("plate", plate);

    const url = params.toString() ? `${API_VEHICLES}?${params}` : API_VEHICLES;
    const raw = await fetchJSON(url, { headers: headersAuth() });
    vehicles = normalizeList(raw);
    render();
  }

  // --- Render ---
  function render() {
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    if (!vehicles.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="text-muted text-center py-3">No hay autos para mostrar</td>
        </tr>
      `;
      return;
    }

    for (const v of vehicles) {
      const thumb = v.image_url
        ? `<img src="${v.image_url}" alt="vehicle" style="width:48px;height:48px;object-fit:cover;border-radius:8px;border:1px solid #ddd;">`
        : `<span class="text-muted small">—</span>`;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="fw-semibold">${v.plate ?? ""}</td>
        <td>${v.make ?? ""}</td>
        <td>${v.model ?? ""}</td>
        <td>${v.year ?? ""}</td>
        <td>${v.customer_name ?? ""}</td>
        <td>${thumb}</td>
        <td>
          <button class="btn btn-outline-secondary btn-sm" data-edit="${v.vehicle_id}">Editar</button>
          <button class="btn btn-outline-danger btn-sm" data-del="${v.vehicle_id}">Eliminar</button>
        </td>
      `;
      tbody.appendChild(tr);
    }

    tbody.querySelectorAll("[data-edit]").forEach(btn => {
      btn.addEventListener("click", () => openModal(btn.getAttribute("data-edit")));
    });
    tbody.querySelectorAll("[data-del]").forEach(btn => {
      btn.addEventListener("click", () => remove(btn.getAttribute("data-del")));
    });
  }

  // --- Modal helpers ---
  function openModal(vehicleId = null) {
    clearMsg();

    document.getElementById("id").value = "";
    document.getElementById("plate").value = "";
    document.getElementById("make").value = "";
    document.getElementById("model").value = "";
    document.getElementById("year").value = "";
    document.getElementById("vin").value = "";
    document.getElementById("color").value = "";
    document.getElementById("image_url").value = "";
    document.getElementById("notes").value = "";

    if (!vehicleId) {
      document.getElementById("modalTitle").textContent = "Nuevo auto";
      modal.show();
      return;
    }

    const v = vehicles.find(x => String(x.vehicle_id) === String(vehicleId));
    if (!v) return;

    document.getElementById("modalTitle").textContent = `Editar auto (${v.plate || ""})`;
    document.getElementById("id").value = v.vehicle_id;
    document.getElementById("customer_id").value = v.customer_id;
    document.getElementById("plate").value = v.plate ?? "";
    document.getElementById("make").value = v.make ?? "";
    document.getElementById("model").value = v.model ?? "";
    document.getElementById("year").value = v.year ?? "";
    document.getElementById("vin").value = v.vin ?? "";
    document.getElementById("color").value = v.color ?? "";
    document.getElementById("image_url").value = v.image_url ?? "";
    document.getElementById("notes").value = v.notes ?? "";
    modal.show();
  }

  // --- CRUD actions ---
  async function save() {
    clearMsg();
    const id = document.getElementById("id").value;

    const payload = {
      customer_id: document.getElementById("customer_id").value,
      plate: document.getElementById("plate").value,
      make: document.getElementById("make").value,
      model: document.getElementById("model").value,
      year: document.getElementById("year").value,
      vin: document.getElementById("vin").value,
      color: document.getElementById("color").value,
      image_url: document.getElementById("image_url").value,
      notes: document.getElementById("notes").value,
    };

    try {
      if (!id) {
        await fetchJSON(API_VEHICLES, {
          method: "POST",
          headers: headersAuth(),
          body: JSON.stringify(payload)
        });
        showMsg("Auto creado.", "success");
      } else {
        await fetchJSON(`${API_VEHICLES}${id}/`, {
          method: "PATCH",
          headers: headersAuth(),
          body: JSON.stringify(payload)
        });
        showMsg("Auto actualizado.", "success");
      }

      modal.hide();
      await loadVehicles();
    } catch (e) {
      showMsg(e.message || String(e), "danger");
    }
  }

  async function remove(id) {
    if (!confirm("¿Eliminar este auto?")) return;
    clearMsg();
    try {
      await fetchJSON(`${API_VEHICLES}${id}/`, {
        method: "DELETE",
        headers: { "Authorization": `Bearer ${token}` }
      });
      showMsg("Auto eliminado.", "success");
      await loadVehicles();
    } catch (e) {
      showMsg(e.message || String(e), "danger");
    }
  }

  // --- Init ---
  document.getElementById("btnNew").addEventListener("click", () => openModal(null));
  document.getElementById("btnSave").addEventListener("click", save);
  document.getElementById("btnApplyFilters").addEventListener("click", loadVehicles);
  document.getElementById("filterPlate").addEventListener("keydown", (e) => {
    if (e.key === "Enter") loadVehicles();
  });

  (async function init() {
    try {
      const ok = await ensureAdmin();
      if (!ok) {
        window.location.href = "./auth.html";
        return;
      }
      await loadCustomers();
      await loadVehicles();
    } catch (_) {
      window.location.href = "./auth.html";
    }
  })();
</script>

</body>
</html>
