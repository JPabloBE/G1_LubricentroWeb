<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin | Productos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand">Admin | Productos</span>
            <button id="btnLogout" class="btn btn-warning btn-sm">Logout</button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <aside class="col-12 col-md-3 col-lg-2 bg-white border-end" style="min-height: calc(100vh - 56px);">
                <div class="p-3">
                    <div class="fw-semibold">Menú</div>
                    <hr>
                    <div class="list-group">
                        <a class="list-group-item list-group-item-action" href="./dashboard.html">Dashboard</a>
                        <a class="list-group-item list-group-item-action" href="./dashboard_categories.html">Catálogo →
                            Categorías</a>
                        <a class="list-group-item list-group-item-action active"
                            href="./dashboard_products.html">Catálogo → Productos</a>
                    </div>
                </div>
            </aside>

            <main class="col-12 col-md-9 col-lg-10 p-4">
                <div id="notAllowed" class="alert alert-danger d-none"></div>

                <div id="app" class="d-none">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="m-0">Productos</h4>
                        <button class="btn btn-primary btn-sm" id="btnNew">Nuevo producto</button>
                    </div>

                    <div class="card shadow-sm">
                        <div class="card-body">

                            <form id="form" class="d-none mb-3">
                                <input type="hidden" id="productId">

                                <div class="row g-2">
                                    <div class="col-12 col-md-4">
                                        <label class="form-label">Categoría</label>
                                        <select id="categoryId" class="form-select">
                                            <option value="">(Sin categoría)</option>
                                        </select>
                                    </div>

                                    <div class="col-12 col-md-4">
                                        <label class="form-label">SKU</label>
                                        <input class="form-control" id="sku">
                                    </div>

                                    <div class="col-12 col-md-4">
                                        <label class="form-label">Activo</label>
                                        <select id="isActive" class="form-select">
                                            <option value="true">Sí</option>
                                            <option value="false">No</option>
                                        </select>
                                    </div>

                                    <div class="col-12 col-md-6">
                                        <label class="form-label">Nombre</label>
                                        <input class="form-control" id="name" required>
                                    </div>

                                    <div class="col-12 col-md-6">
                                        <label class="form-label">Descripción</label>
                                        <input class="form-control" id="description">
                                    </div>

                                    <div class="col-12">
                                        <label class="form-label">Imagen (URL)</label>
                                        <input class="form-control" id="imageUrl" placeholder="https://...">
                                    </div>


                                    <div class="col-12 col-md-4">
                                        <label class="form-label">Precio unitario</label>
                                        <input class="form-control" id="unitPrice" type="number" step="0.01" value="0">
                                    </div>

                                    <div class="col-12 col-md-4">
                                        <label class="form-label">Costo</label>
                                        <input class="form-control" id="cost" type="number" step="0.01" value="0">
                                    </div>

                                    <div class="col-12 col-md-4">
                                        <label class="form-label">Stock</label>
                                        <input class="form-control" id="stockQty" type="number" step="0.01" value="0">
                                    </div>
                                </div>

                                <div class="mt-3 d-flex gap-2">
                                    <button class="btn btn-success btn-sm" type="submit">Guardar</button>
                                    <button class="btn btn-secondary btn-sm" type="button"
                                        id="btnCancel">Cancelar</button>
                                </div>

                                <hr>
                            </form>

                            <div class="table-responsive">
                                <table class="table table-sm align-middle">
                                    <thead>
                                        <tr>
                                            <th>Imagen</th>
                                            <th>Nombre</th>
                                            <th>SKU</th>
                                            <th>Categoría</th>
                                            <th class="text-end">Precio</th>
                                            <th class="text-end">Stock</th>
                                            <th>Activo</th>
                                            <th class="text-end">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody"></tbody>
                                </table>
                            </div>

                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        const API_BASE = "http://localhost:8000";
        const token = localStorage.getItem("access_token");

        function authHeaders() {
            return {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            };
        }

        async function fetchJSON(url, options = {}) {
            const res = await fetch(url, options);
            const text = await res.text();
            let data = null;
            try { data = text ? JSON.parse(text) : null; } catch (_) { }

            if (!res.ok) {
                throw new Error(data ? JSON.stringify(data) : (text || res.statusText));
            }
            return data;
        }

        function normalizeList(apiResponse) {
            if (Array.isArray(apiResponse)) return apiResponse;
            if (apiResponse && Array.isArray(apiResponse.results)) return apiResponse.results;
            return [];
        }

        async function ensureAdmin() {
            if (!token) return false;
            const me = await fetchJSON(`${API_BASE}/api/auth/me/`, {
                headers: { "Authorization": `Bearer ${token}` }
            });
            return me.user_type === "admin" || me.is_staff === true || me.is_superuser === true;
        }

        function showUiError(msg) {
            const el = document.getElementById("notAllowed");
            el.classList.remove("d-none");
            el.textContent = msg;
        }

        document.getElementById("btnLogout").addEventListener("click", async () => {
            try {
                await fetch(`${API_BASE}/api/auth/logout/`, {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${token}` }
                });
            } catch (_) { }

            localStorage.removeItem("access_token");
            localStorage.removeItem("refresh_token");
            window.location.href = "./auth.html";
        });

        // --- State ---
        let categories = [];
        let products = [];

        function fmtMoney(v) {
            const n = Number(v || 0);
            return n.toFixed(2);
        }

        function safeImg(url) {
            if (!url) return "";
            const u = String(url).trim();
            if (!u) return "";
            return u;
        }

        // --- Loaders ---
        async function loadCategories() {
            const raw = await fetchJSON(`${API_BASE}/api/catalog/categories/`, { headers: authHeaders() });
            categories = normalizeList(raw);

            const sel = document.getElementById("categoryId");
            sel.innerHTML = `<option value="">(Sin categoría)</option>`;

            for (const c of categories) {
                const opt = document.createElement("option");
                opt.value = c.category_id;
                opt.textContent = c.name;
                sel.appendChild(opt);
            }
        }

        async function loadProducts() {
            const raw = await fetchJSON(`${API_BASE}/api/catalog/products/`, { headers: authHeaders() });
            products = normalizeList(raw);
            render();
        }

        // --- Render ---
        function render() {
            const tbody = document.getElementById("tbody");
            tbody.innerHTML = "";

            if (!products.length) {
                tbody.innerHTML = `
        <tr>
          <td colspan="8" class="text-muted text-center py-3">No hay productos para mostrar</td>
        </tr>
      `;
                return;
            }

            for (const p of products) {
                const imgUrl = safeImg(p.image_url);
                const imgCell = imgUrl
                    ? `<img src="${imgUrl}"
                 alt="img"
                 style="width:48px;height:48px;object-fit:cover;border-radius:8px;"
                 onerror="this.outerHTML='<span class=&quot;text-muted small&quot;>—</span>'">`
                    : `<span class="text-muted small">—</span>`;

                const tr = document.createElement("tr");
                tr.innerHTML = `
        <td>${imgCell}</td>
        <td class="fw-semibold">${p.name ?? ""}</td>
        <td>${p.sku ?? ""}</td>
        <td>${p.category_name ?? ""}</td>
        <td class="text-end">${fmtMoney(p.unit_price)}</td>
        <td class="text-end">${fmtMoney(p.stock_qty)}</td>
        <td>${p.is_active ? "Sí" : "No"}</td>
        <td class="text-end">
          <button class="btn btn-outline-secondary btn-sm" data-edit="${p.product_id}">Editar</button>
          <button class="btn btn-outline-danger btn-sm" data-del="${p.product_id}">Eliminar</button>
        </td>
      `;
                tbody.appendChild(tr);
            }

            tbody.querySelectorAll("[data-edit]").forEach(btn => {
                btn.addEventListener("click", () => openForm(btn.getAttribute("data-edit")));
            });
            tbody.querySelectorAll("[data-del]").forEach(btn => {
                btn.addEventListener("click", () => remove(btn.getAttribute("data-del")));
            });
        }

        // --- Form helpers ---
        function openForm(productId = null) {
            document.getElementById("form").classList.remove("d-none");

            if (!productId) {
                document.getElementById("productId").value = "";
                document.getElementById("categoryId").value = "";
                document.getElementById("sku").value = "";
                document.getElementById("name").value = "";
                document.getElementById("description").value = "";
                document.getElementById("imageUrl").value = ""; // ✅ NUEVO
                document.getElementById("unitPrice").value = "0";
                document.getElementById("cost").value = "0";
                document.getElementById("stockQty").value = "0";
                document.getElementById("isActive").value = "true";
                return;
            }

            const p = products.find(x => String(x.product_id) === String(productId));
            if (!p) return;

            document.getElementById("productId").value = p.product_id;
            document.getElementById("categoryId").value = p.category_id ?? "";
            document.getElementById("sku").value = p.sku ?? "";
            document.getElementById("name").value = p.name ?? "";
            document.getElementById("description").value = p.description ?? "";
            document.getElementById("imageUrl").value = p.image_url ?? ""; // ✅ NUEVO
            document.getElementById("unitPrice").value = p.unit_price ?? "0";
            document.getElementById("cost").value = p.cost ?? "0";
            document.getElementById("stockQty").value = p.stock_qty ?? "0";
            document.getElementById("isActive").value = p.is_active ? "true" : "false";
        }

        function closeForm() {
            document.getElementById("form").classList.add("d-none");
        }

        // --- CRUD actions ---
        async function save(e) {
            e.preventDefault();

            const productId = document.getElementById("productId").value;
            const categoryId = document.getElementById("categoryId").value || null;

            const payload = {
                category_id: categoryId,
                sku: document.getElementById("sku").value.trim() || null,
                name: document.getElementById("name").value.trim(),
                description: document.getElementById("description").value.trim() || null,
                image_url: document.getElementById("imageUrl").value.trim() || null, // ✅ NUEVO
                unit_price: Number(document.getElementById("unitPrice").value || 0),
                cost: Number(document.getElementById("cost").value || 0),
                stock_qty: Number(document.getElementById("stockQty").value || 0),
                is_active: document.getElementById("isActive").value === "true"
            };

            if (!payload.name) {
                showUiError("El nombre es obligatorio.");
                return;
            }

            if (!productId) {
                await fetchJSON(`${API_BASE}/api/catalog/products/`, {
                    method: "POST",
                    headers: authHeaders(),
                    body: JSON.stringify(payload)
                });
            } else {
                await fetchJSON(`${API_BASE}/api/catalog/products/${productId}/`, {
                    method: "PUT",
                    headers: authHeaders(),
                    body: JSON.stringify(payload)
                });
            }

            closeForm();
            await loadProducts();
        }

        async function remove(productId) {
            if (!confirm("¿Eliminar producto?")) return;

            await fetchJSON(`${API_BASE}/api/catalog/products/${productId}/`, {
                method: "DELETE",
                headers: authHeaders()
            });

            await loadProducts();
        }

        // --- Wiring ---
        document.getElementById("btnNew").addEventListener("click", () => openForm(null));
        document.getElementById("btnCancel").addEventListener("click", closeForm);
        document.getElementById("form").addEventListener("submit", save);

        // --- Init ---
        (async () => {
            try {
                const ok = await ensureAdmin();
                if (!ok) {
                    showUiError("No autorizado. Solo admin puede ver este módulo.");
                    return;
                }
                document.getElementById("app").classList.remove("d-none");
                await loadCategories();
                await loadProducts();
            } catch (err) {
                console.error(err);
                showUiError("Error cargando productos: " + err.message);
            }
        })();
    </script>


</body>

</html>